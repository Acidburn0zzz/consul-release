#!/bin/bash -exu

SCRIPT_NAME=$(basename $0)
RUN_DIR=/var/vcap/sys/run/consul_agent
LOG_DIR=/var/vcap/sys/log/consul_agent
JOB_DIR=/var/vcap/jobs/consul_agent

exec > >(tee -a >(logger -p user.info -t vcap.${SCRIPT_NAME}.stdout) | awk -W interactive '{lineWithDate="echo [`date +\"%Y-%m-%d %H:%M:%S%z\"`] \"" $0 "\""; system(lineWithDate)  }' >> $LOG_DIR/${SCRIPT_NAME}.log)
exec 2> >(tee -a >(logger -p user.error -t vcap.${SCRIPT_NAME}.stderr) | awk -W interactive '{lineWithDate="echo [`date +\"%Y-%m-%d %H:%M:%S%z\"`] \"" $0 "\""; system(lineWithDate)  }' >> $LOG_DIR/${SCRIPT_NAME}.err.log)

function main() {
  case ${1} in
    start)
      /var/vcap/packages/dnsmasq/sbin/dnsmasq \
      <%= p("consul.dnsmasq.nameservers").map { |server| "--server=/#{server}"}.join(" ") %> \
      --log-facility ${LOG_DIR}/dnsmasq.log \
      --keep-in-foreground &

      echo "${!}" > ${RUN_DIR}/dnsmasq.pid
      ;;

    stop)
      kill -9 $(cat ${RUN_DIR}/dnsmasq.pid)
      rm ${RUN_DIR}/dnsmasq.pid
      ;;

    *)
      echo "Usage: ${0} {start|stop}"
      ;;
  esac
}

main $@
